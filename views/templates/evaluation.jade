extends ../layout
block body
  include ../navbar
  script(src="/js/fabric.min.js")

  .container
    .panel.panel-default
      .panel-heading
        #job
      .panel-body
        .col-md-3
          .row
            if job        
              h4=job.name
              p=job.desc
              #jobid.hide=job.id
              hr
                
          textarea#imageTranscription.transcribingTextarea(name="dataEvaluation" width="100%")

          a.btn.btn-default.button-flat.btn-superbig.btn-block.selectButton
            b Submit
          a.btn.btn-default.button-flat.btn-superbig.btn-block.selectButton 
            b No Comment
          a.btn.btn-default.button-flat.btn-superbig.btn-block.selectButton  
            b Skip this task

        .col-sm-9
          .well.well-big
            #currentTask
              p#task
                //- p I have a website located at 
                //-   a(href='http://www.facebook.com') www.facebook.com
                //- p Please provide me with any thoughts or concerns about my web design, something, and something else.

  script.

    function select(){

      //- dont technically need this...
      //- var src = $("#currentTask").find('p').attr('src')
      var task_id  = $("#currentTask").find('p').attr('data-id')

      var job_id  = $("#jobid").text()
      var val = $('#dataEvaluation').val();

      var inputbtn = $(this).text();

      console.log(val)
      io.socket.post("/actions/new_do", {task_id:task_id,
        job_id:job_id, 
        input_type:inputbtn,
        input:val, 
        type:"evaluation"
      }, function(new_task,info){

        console.log(new_task)
        console.log(info)

        $('#dataEvaluation').val("");

      })

    }

    function toCanvas(){

        var src = $(this).find('img').attr('info')
        var id  = $(this).find('img').attr('data-id')
        $(".featureImage.active").removeClass("active")
        $(this).addClass("active")
        //- $("#currentTask p").attr('innerHTML', src)
        $("#currentTask p").text(src);
        $("#currentTask p").attr('data-id',id)
    }

    $(document).on( "click", ".selectButton", select )
    $(document).on( "click", ".featureImage", toCanvas )

    var featureModel = new $.eventModel();

    featureModel.on('created', function(info,item) {
      var a = item.data.tasks
      $.map(a, function(d){
        console.log(d)
        $("#job").append($("<span>", {
          "data-id":d.id,
          class:"small featureImage"
        }).append($("<img>",{
          src: 'https://ageofex.files.wordpress.com/2012/11/hidden-text-example-31.gif',
          "info":d.src,
          "data-id":d.id
        })))
      })
      $(".featureImage").first().click();
    });

    featureModel.on('updated', function(info,item) {
      $.map(item.data, function(val, attr){
        if($("#"+item.id+" #"+attr).text())
          $("#"+item.id+" #"+attr).text(val)
        else $("#"+item.id).append($("<div>",{id:attr,text:val}))
        console.log(item.id);
      })
    });

    function dataset_glue(model){
      io.socket.on( model, function(dataset){
        featureModel.emit(dataset.verb, dataset);
      })

      io.socket.get( "/"+model+"/find", {type:"evaluation"}, function(datasets){
        console.log(datasets);
        $.map(datasets, function(dataset){
          featureModel.emit('created', {
            id:dataset.id,
            data:dataset
          })
        })
      })
      $(".featureImage").first().click();
    }

    $(document).ready(function(){

      dataset_glue("job");

    });
